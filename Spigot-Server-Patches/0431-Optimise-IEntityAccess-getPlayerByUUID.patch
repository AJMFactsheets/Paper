From e727de5f6ad2fa568d448d5364a36c2f117171f4 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Fri, 27 Dec 2019 19:37:46 -0800
Subject: [PATCH] Optimise IEntityAccess#getPlayerByUUID

Use the world entity map instead of iterating over all players

diff --git a/src/main/java/net/minecraft/server/IEntityAccess.java b/src/main/java/net/minecraft/server/IEntityAccess.java
index e183673f4..c3b640c91 100644
--- a/src/main/java/net/minecraft/server/IEntityAccess.java
+++ b/src/main/java/net/minecraft/server/IEntityAccess.java
@@ -237,6 +237,12 @@ public interface IEntityAccess {
 
     @Nullable
     default EntityHuman b(UUID uuid) {
+        // Paper start - allow WorldServer to override
+        return this.getPlayerByUUID(uuid);
+    }
+    @Nullable
+    default EntityHuman getPlayerByUUID(UUID uuid) {
+        // Paper
         for (int i = 0; i < this.getPlayers().size(); ++i) {
             EntityHuman entityhuman = (EntityHuman) this.getPlayers().get(i);
 
diff --git a/src/main/java/net/minecraft/server/WorldServer.java b/src/main/java/net/minecraft/server/WorldServer.java
index 39a7e32a7..474ebab60 100644
--- a/src/main/java/net/minecraft/server/WorldServer.java
+++ b/src/main/java/net/minecraft/server/WorldServer.java
@@ -531,6 +531,15 @@ public class WorldServer extends World {
     }
     // Paper end
 
+    // Paper start - optimise getPlayerByUUID
+    @Nullable
+    @Override
+    public EntityHuman getPlayerByUUID(UUID uuid) {
+        Entity player = this.entitiesByUUID.get(uuid);
+        return (player instanceof EntityHuman) ? (EntityHuman)player : null;
+    }
+    // Paper end
+
     // Add env and gen to constructor
     public WorldServer(MinecraftServer minecraftserver, Executor executor, WorldNBTStorage worldnbtstorage, WorldData worlddata, DimensionManager dimensionmanager, GameProfilerFiller gameprofilerfiller, WorldLoadListener worldloadlistener, org.bukkit.World.Environment env, org.bukkit.generator.ChunkGenerator gen) {
         super(worlddata, dimensionmanager, (world, worldprovider) -> {
-- 
2.24.0.windows.2

